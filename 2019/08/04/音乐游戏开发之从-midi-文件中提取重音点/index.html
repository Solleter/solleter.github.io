<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="日常记录"><title>音乐游戏开发之从 midi 文件中提取重音点 | F社</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><header class="wrapper header"><div class="container blog-title"><a class="title" id="logo" href="/.">F社</a><span class="subtitle">上你娘的班</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div><input id="menu" type="checkbox"><div class="container nav-items"><a class="sidebar-nav-item active" href="/">主页</a><a class="sidebar-nav-item" href="/archives">分类归档</a><a class="sidebar-nav-item" href="/about">关于</a><a class="sidebar-nav-item" href="/links">收集</a></div></header><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><!--each nav, name in theme.menu//+a_with_current(nav, __(name))--></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/">Python</a><a class="post-tag-link" href="/tags/游戏开发/">游戏开发</a></div><div class="post-time">2019-08-04</div></div></div><div class="container post-header"><h1>音乐游戏开发之从 midi 文件中提取重音点</h1></div><div class="container post-content"><p>在开发音乐游戏的过程中，经常需要进行谱子的创作，如果人工手打，很容易造成不准和效率低下的情况。而通过音频人员做的midi文件中提取指定的信号，然后自动生成谱子，将大大提高效率和准确度。</p>
<p>本篇文章将解释使用 <code>Python</code> 从 <code>midi</code> 文件中提取指定信号，然后生成谱子的逻辑。</p>
<h2 id="1-与-midi-文件相关的东西"><a href="#1-与-midi-文件相关的东西" class="headerlink" title="1. 与 midi 文件相关的东西"></a><strong>1. 与 <code>midi</code> 文件相关的东西</strong></h2><p>midi 文件中有一个信号的概念，例如 <code>note_on</code> , <code>note_off</code>，为了做谱子，我们为不同的信号赋予不同的数值，然后以此来生成不同的谱子。</p>
<h2 id="2-使用-midi-文件生成谱子的逻辑"><a href="#2-使用-midi-文件生成谱子的逻辑" class="headerlink" title="2. 使用 midi 文件生成谱子的逻辑"></a><strong>2. 使用 midi 文件生成谱子的逻辑</strong></h2><p>以 QQ 炫舞为例，游戏中有多种<code>点</code>，例如点击的，滑动的，需要按住的，等等。这里我们用 midi 中的<code>note_on</code>事件做逻辑。首先，一首歌在不同的地方有重音，音频人员只要在对应的时间点上的 <code>note_on</code>事件设定我们约定好的值，例如这里用<code>10</code>作为点击的点，<code>11</code>作为滑动的点，<code>12</code>作为长按的点。<br>拿到作好的 midi 文件后，我们只需要扫描整个 midi 文件中的 <code>note_on</code>事件，然后取出里面的时间点，和对应的值，就可以生成一个可以在游戏中用的谱子。一个谱子是什么样子的，完全由音频人员与策划去决定，程序这边只需要生成就可以。</p>
<h2 id="3-使用-Python-解析-midi-文件数据"><a href="#3-使用-Python-解析-midi-文件数据" class="headerlink" title="3. 使用 Python 解析 midi 文件数据"></a><strong>3. 使用 Python 解析 midi 文件数据</strong></h2><blockquote>
<p>这里要用的几个 Python 库，所以需要先安装，运行下面的命令安装 mido。（这里假设开发人员对 Python 有基本的了解）<br><code>pip3 install mido</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mido</span><br><span class="line"><span class="keyword">from</span> mido <span class="keyword">import</span> MidiFile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">midi_file_path = <span class="string">'./test.mid'</span></span><br><span class="line">bpm = <span class="number">121</span> <span class="comment"># BPM 是必须的，这一个音频人员知道是什么</span></span><br><span class="line"></span><br><span class="line">tap_value = <span class="number">10</span>  <span class="comment"># 定义点击的值</span></span><br><span class="line">wipe_value = <span class="number">11</span> <span class="comment"># 定义滑动的值</span></span><br><span class="line">hold_value = <span class="number">12</span> <span class="comment"># 定义按住的值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这一个是为了适应人的听感，而加的偏移值，midi 文件的时间是准的</span></span><br><span class="line"><span class="comment"># 但是人耳朵听起来可能不是很准，最终是以人耳听起来准为目标</span></span><br><span class="line"><span class="comment"># 这个值不固定，根据自己游戏的音乐类型不同，以及做音频的人的听感不同，而设定，可以是正的，可以是负的</span></span><br><span class="line">time_offset = <span class="number">0.25</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_base_notes_data</span><span class="params">(_midi_file_path, _bpm)</span>:</span></span><br><span class="line">    mid = MidiFile(_midi_file_path)</span><br><span class="line">    tempo = mido.bpm2tempo(_bpm)</span><br><span class="line">    _note_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, track <span class="keyword">in</span> enumerate(mid.tracks):</span><br><span class="line">        print(<span class="string">'Track &#123;&#125;: &#123;&#125;'</span>.format(i, track.name))</span><br><span class="line">        passed_time = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> msg <span class="keyword">in</span> track:</span><br><span class="line">            ab_time = mido.tick2second(msg.time, mid.ticks_per_beat, tempo)</span><br><span class="line">            real_time = ab_time + passed_time</span><br><span class="line">            passed_time += ab_time</span><br><span class="line">            <span class="comment"># print(msg, " passed time=" + str(ab_time), " read time=" + str(round(real_time, 3)))</span></span><br><span class="line">            <span class="keyword">if</span> msg.type == <span class="string">"note_on"</span>:</span><br><span class="line">                note_value = msg.note</span><br><span class="line">                <span class="keyword">if</span> note_value == tap_value:</span><br><span class="line">                    note_name = <span class="string">"tap"</span></span><br><span class="line">                <span class="keyword">elif</span> note_value == wipe_value:</span><br><span class="line">                    note_name = <span class="string">"wipe"</span></span><br><span class="line">                <span class="keyword">elif</span> note_value == hold_value:</span><br><span class="line">                    note_name = <span class="string">"hold"</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    note_name = <span class="string">""</span></span><br><span class="line">                <span class="keyword">if</span> note_name != <span class="string">""</span>:</span><br><span class="line">                    note_data = &#123;<span class="string">"note_name"</span>: note_name, <span class="string">"time"</span>: round(real_time + time_offset, <span class="number">3</span>)&#125;</span><br><span class="line">                    _note_list.append(note_data)</span><br><span class="line">                    print(note_data)</span><br><span class="line">    <span class="keyword">return</span> _note_list</span><br><span class="line"></span><br><span class="line">get_base_notes_data(midi_file_path, bpm)</span><br></pre></td></tr></table></figure>
<p>运行代码 <code>python3 xxx.py</code> （xxx 是你保存的 python 文件的名字）</p>
<blockquote>
<p>这段代码只实现了最核心的 midi 数据提取，具体的自动化逻辑需要使用者自己写，例如当前有100个 midi 文件，不可能手动一个一个生成。</p>
</blockquote>
</div></div><script type="text/x-mathjax-config">
   MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    }); 
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sexy-game-boy';
var disqus_identifier = '2019/08/04/音乐游戏开发之从-midi-文件中提取重音点/';
var disqus_title = '音乐游戏开发之从 midi 文件中提取重音点';
var disqus_url = 'https://solleter.me/2019/08/04/音乐游戏开发之从-midi-文件中提取重音点/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-140200191-1');ga('send','pageview');</script></body></html>